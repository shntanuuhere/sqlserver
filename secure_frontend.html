<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Student Information System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-overlay { transition: opacity 0.2s ease-in-out; }
        .sortable { cursor: pointer; user-select: none; }
        .sortable:hover { background-color: #f0f4f8; }
        .hidden { display: none !important; }
        .role-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .role-student { background-color: #dbeafe; color: #1e40af; }
        .role-teacher { background-color: #dcfce7; color: #166534; }
        .role-admin { background-color: #fef3c7; color: #92400e; }
        .role-board { background-color: #fce7f3; color: #be185d; }
        .role-super-admin { background-color: #f3e8ff; color: #7c3aed; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100">

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center modal-overlay z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 class="text-2xl font-semibold mb-4 text-center">Secure Login</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Username/Email</label>
                    <input type="text" id="login-username" required class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="login-password" required class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 transition">
                    Login
                </button>
            </form>
            <p id="login-status" class="mt-3 text-center font-medium"></p>
        </div>
    </div>

    <!-- Main Application -->
    <div id="main-app" class="hidden">
        <!-- Header -->
        <div class="bg-white shadow-sm border-b">
            <div class="container mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-gray-800">Secure Student Information System</h1>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-600">Welcome,</span>
                            <span id="current-user" class="font-medium"></span>
                            <span id="user-role" class="role-badge"></span>
                        </div>
                        <button id="logout-btn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="container mx-auto p-6 max-w-7xl">
            <!-- Navigation Tabs -->
            <div class="bg-white rounded-lg shadow-md mb-8">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8 px-6">
                        <button class="tab-btn active py-4 px-1 border-b-2 border-blue-500 font-medium text-blue-600" data-tab="students">
                            Students
                        </button>
                        <button class="tab-btn py-4 px-1 border-b-2 border-transparent font-medium text-gray-500 hover:text-gray-700" data-tab="grade-requests">
                            Grade Requests
                        </button>
                        <button class="tab-btn py-4 px-1 border-b-2 border-transparent font-medium text-gray-500 hover:text-gray-700" data-tab="verification">
                            Verification
                        </button>
                        <button class="tab-btn py-4 px-1 border-b-2 border-transparent font-medium text-gray-500 hover:text-gray-700" data-tab="audit-logs" id="audit-tab" style="display: none;">
                            Audit Logs
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Students Tab -->
            <div id="students-tab" class="tab-content">
                <!-- Add Student Form -->
                <div class="bg-white p-6 rounded-lg shadow-md mb-8" id="add-student-section" style="display: none;">
                    <h2 class="text-2xl font-semibold mb-4">Add a New Student</h2>
                    <form id="insert-form" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input type="number" id="student-id" placeholder="Student ID" required class="w-full p-2 border border-gray-300 rounded-md">
                        <input type="text" id="first-name" placeholder="First Name" required class="w-full p-2 border border-gray-300 rounded-md">
                        <input type="text" id="last-name" placeholder="Last Name" required class="w-full p-2 border border-gray-300 rounded-md">
                        <input type="text" id="major" placeholder="Major" class="w-full p-2 border border-gray-300 rounded-md">
                        <input type="text" id="school" placeholder="School" class="w-full p-2 border border-gray-300 rounded-md">
                        <input type="text" id="grade" placeholder="Grade/Percentage" class="w-full p-2 border border-gray-300 rounded-md">
                        <input type="text" id="board" placeholder="Board (e.g., CBSE)" class="w-full p-2 border border-gray-300 rounded-md">
                        <input type="number" id="passing-year" placeholder="Passing Year" class="w-full p-2 border border-gray-300 rounded-md" min="1900" max="2100">
                        <button type="submit" class="md:col-span-4 w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 transition">
                            Insert Record
                        </button>
                    </form>
                    <p id="insert-status" class="mt-3 text-center font-medium"></p>
                </div>

                <!-- Students Table -->
                <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                        <h2 class="text-2xl font-semibold">Student Data</h2>
                        <div class="flex items-center gap-4 w-full md:w-auto">
                            <input type="text" id="search-bar" placeholder="Search students..." class="w-full md:w-64 p-2 border border-gray-300 rounded-md">
                            <button id="fetch-btn" class="bg-gray-700 text-white font-semibold py-2 px-4 rounded-md hover:bg-gray-800 transition whitespace-nowrap">
                                Refresh Data
                            </button>
                        </div>
                    </div>
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase sortable" data-sort="StudentID">ID</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase sortable" data-sort="FirstName">First Name</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase sortable" data-sort="LastName">Last Name</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase sortable" data-sort="Major">Major</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase sortable" data-sort="School">School</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase sortable" data-sort="Grade">Grade</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase sortable" data-sort="Board">Board</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase sortable" data-sort="PassingYear">Passing Year</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Verified</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="data-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be loaded here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Grade Requests Tab -->
            <div id="grade-requests-tab" class="tab-content hidden">
                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h2 class="text-2xl font-semibold mb-4">Grade Change Requests</h2>
                    <div class="mb-4">
                        <button id="new-request-btn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition">
                            New Grade Change Request
                        </button>
                    </div>
                    <div id="grade-requests-table" class="overflow-x-auto">
                        <!-- Grade requests will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Verification Tab -->
            <div id="verification-tab" class="tab-content hidden">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">Board Verification</h2>
                    <div id="verification-content">
                        <!-- Verification content will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Audit Logs Tab -->
            <div id="audit-logs-tab" class="tab-content hidden">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">Audit Logs</h2>
                    <div id="audit-logs-content">
                        <!-- Audit logs will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center modal-overlay z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
            <h2 class="text-2xl font-semibold mb-4">Edit Student Information</h2>
            <form id="edit-form" class="space-y-4">
                <input type="hidden" id="original-student-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Student ID</label>
                        <input type="number" id="edit-student-id" required class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">First Name</label>
                        <input type="text" id="edit-first-name" required class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Last Name</label>
                        <input type="text" id="edit-last-name" required class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Major</label>
                        <input type="text" id="edit-major" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">School</label>
                        <input type="text" id="edit-school" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Grade/Percentage</label>
                        <input type="text" id="edit-grade" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Board</label>
                        <input type="text" id="edit-board" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Passing Year</label>
                        <input type="number" id="edit-passing-year" class="mt-1 w-full p-2 border border-gray-300 rounded-md" min="1900" max="2100">
                    </div>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancel-edit-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-300 transition">Cancel</button>
                    <button type="submit" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700 transition">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Grade Change Request Modal -->
    <div id="grade-request-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center modal-overlay z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
            <h2 class="text-2xl font-semibold mb-4">Request Grade Change</h2>
            <form id="grade-request-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Student ID</label>
                    <input type="number" id="request-student-id" required class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">New Grade</label>
                    <input type="text" id="request-new-grade" required class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Change Type</label>
                    <select id="request-change-type" required class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                        <option value="">Select type</option>
                        <option value="correction">Correction</option>
                        <option value="revaluation">Revaluation</option>
                        <option value="appeal">Appeal</option>
                        <option value="administrative">Administrative</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Reason</label>
                    <textarea id="request-reason" required rows="3" class="mt-1 w-full p-2 border border-gray-300 rounded-md"></textarea>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancel-request-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-300 transition">Cancel</button>
                    <button type="submit" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700 transition">Submit Request</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const BASE_URL = 'https://my-sql-app-latest.onrender.com';
        
        // --- State Management ---
        let currentUser = null;
        let authToken = null;
        let allStudents = [];
        let sortColumn = 'StudentID';
        let sortDirection = 'asc';

        // --- DOM Elements ---
        const loginModal = document.getElementById('login-modal');
        const mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const loginStatus = document.getElementById('login-status');
        const currentUserSpan = document.getElementById('current-user');
        const userRoleSpan = document.getElementById('user-role');
        const logoutBtn = document.getElementById('logout-btn');

        // --- Authentication Functions ---
        function showLoginModal() {
            loginModal.classList.remove('hidden');
            mainApp.classList.add('hidden');
        }

        function hideLoginModal() {
            loginModal.classList.add('hidden');
            mainApp.classList.remove('hidden');
        }

        function updateUserInfo(user) {
            currentUser = user;
            currentUserSpan.textContent = user.username;
            userRoleSpan.textContent = user.role.replace('_', ' ').toUpperCase();
            userRoleSpan.className = `role-badge role-${user.role.replace('_', '-')}`;
            
            // Show/hide elements based on role
            const addStudentSection = document.getElementById('add-student-section');
            const auditTab = document.getElementById('audit-tab');
            
            if (user.role === 'admin' || user.role === 'super_admin') {
                addStudentSection.style.display = 'block';
            } else {
                addStudentSection.style.display = 'none';
            }
            
            if (user.role === 'super_admin') {
                auditTab.style.display = 'block';
            } else {
                auditTab.style.display = 'none';
            }
        }

        function getAuthHeaders() {
            return {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            };
        }

        // --- API Functions ---
        async function apiCall(url, options = {}) {
            const defaultOptions = {
                headers: getAuthHeaders()
            };
            
            const response = await fetch(url, { ...defaultOptions, ...options });
            
            if (response.status === 401) {
                // Token expired or invalid
                showLoginModal();
                throw new Error('Authentication required');
            }
            
            return response;
        }

        // --- Login/Logout ---
        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            try {
                const response = await fetch(`${BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    authToken = result.token;
                    updateUserInfo(result.user);
                    hideLoginModal();
                    loginStatus.textContent = '';
                    loginForm.reset();
                    
                    // Load initial data
                    if (currentUser.role !== 'student') {
                        fetchData();
                    }
                } else {
                    loginStatus.textContent = result.message || 'Login failed';
                    loginStatus.className = 'mt-3 text-center font-medium text-red-600';
                }
            } catch (error) {
                loginStatus.textContent = 'Login failed: ' + error.message;
                loginStatus.className = 'mt-3 text-center font-medium text-red-600';
            }
        }

        async function handleLogout() {
            try {
                await apiCall(`${BASE_URL}/api/auth/logout`, { method: 'POST' });
            } catch (error) {
                console.log('Logout error:', error);
            } finally {
                authToken = null;
                currentUser = null;
                showLoginModal();
            }
        }

        // --- Student Management Functions ---
        async function fetchData() {
            const dataTableBody = document.getElementById('data-table-body');
            dataTableBody.innerHTML = '<tr><td colspan="10" class="text-center p-4">Loading...</td></tr>';
            
            try {
                const response = await apiCall(`${BASE_URL}/api/students`);
                const data = await response.json();
                
                if (response.ok) {
                    allStudents = data;
                    renderTable();
                } else {
                    dataTableBody.innerHTML = `<tr><td colspan="10" class="text-center p-4 text-red-500">Error: ${data.error}</td></tr>`;
                }
            } catch (error) {
                dataTableBody.innerHTML = `<tr><td colspan="10" class="text-center p-4 text-red-500">Error: ${error.message}</td></tr>`;
            }
        }

        function renderTable() {
            const searchBar = document.getElementById('search-bar');
            const dataTableBody = document.getElementById('data-table-body');
            const searchTerm = searchBar.value.toLowerCase();
            
            const filteredStudents = allStudents.filter(student => {
                return Object.values(student).some(val => 
                    String(val || '').toLowerCase().includes(searchTerm)
                );
            });

            filteredStudents.sort((a, b) => {
                const valA = a[sortColumn] || '';
                const valB = b[sortColumn] || '';
                let comparison = 0;
                if (valA > valB) comparison = 1;
                else if (valA < valB) comparison = -1;
                return sortDirection === 'asc' ? comparison : comparison * -1;
            });

            if (filteredStudents.length === 0) {
                dataTableBody.innerHTML = `<tr><td colspan="10" class="text-center p-4">No matching students found.</td></tr>`;
            } else {
                dataTableBody.innerHTML = filteredStudents.map(s => `
                    <tr data-student='${JSON.stringify(s)}'>
                        <td class="px-4 py-4 whitespace-nowrap">${s.StudentID || ''}</td>
                        <td class="px-4 py-4 whitespace-nowrap">${s.FirstName || ''}</td>
                        <td class="px-4 py-4 whitespace-nowrap">${s.LastName || ''}</td>
                        <td class="px-4 py-4 whitespace-nowrap">${s.Major || ''}</td>
                        <td class="px-4 py-4 whitespace-nowrap">${s.School || ''}</td>
                        <td class="px-4 py-4 whitespace-nowrap">${s.Grade || ''}</td>
                        <td class="px-4 py-4 whitespace-nowrap">${s.Board || ''}</td>
                        <td class="px-4 py-4 whitespace-nowrap">${s.PassingYear || ''}</td>
                        <td class="px-4 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded-full ${s.IsVerified ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${s.IsVerified ? 'Verified' : 'Not Verified'}
                            </span>
                        </td>
                        <td class="px-4 py-4 space-x-2 whitespace-nowrap">
                            ${canEditGrades() ? `<button class="edit-btn text-blue-600 hover:text-blue-800 font-medium">Edit</button>` : ''}
                            ${canDeleteRecords() ? `<button class="delete-btn text-red-600 hover:text-red-800 font-medium">Delete</button>` : ''}
                            ${canRequestGradeChange() ? `<button class="request-grade-btn text-green-600 hover:text-green-800 font-medium">Request Grade Change</button>` : ''}
                        </td>
                    </tr>
                `).join('');
            }
            
            // Update sort indicators
            document.querySelectorAll('th.sortable').forEach(th => {
                th.innerHTML = th.innerHTML.replace(/ [▲▼]/, '');
                if (th.dataset.sort === sortColumn) {
                    th.innerHTML += sortDirection === 'asc' ? ' ▲' : ' ▼';
                }
            });
        }

        // --- Permission Functions ---
        function canEditGrades() {
            return currentUser && (currentUser.role === 'admin' || currentUser.role === 'super_admin');
        }

        function canDeleteRecords() {
            return currentUser && (currentUser.role === 'admin' || currentUser.role === 'super_admin');
        }

        function canRequestGradeChange() {
            return currentUser && ['student', 'teacher', 'admin', 'board_official', 'super_admin'].includes(currentUser.role);
        }

        function canApproveChanges() {
            return currentUser && (currentUser.role === 'board_official' || currentUser.role === 'super_admin');
        }

        // --- Event Handlers ---
        function handleTableClick(event) {
            const target = event.target;
            const row = target.closest('tr');
            if (!row || !row.dataset.student) return;
            
            const studentData = JSON.parse(row.dataset.student);
            const studentId = studentData.StudentID;

            if (target.classList.contains('delete-btn')) {
                if (confirm(`Are you sure you want to delete student ${studentData.FirstName} (ID: ${studentId})?`)) {
                    deleteStudent(studentId);
                }
            } else if (target.classList.contains('edit-btn')) {
                openEditModal(studentData);
            } else if (target.classList.contains('request-grade-btn')) {
                openGradeRequestModal(studentId);
            }
        }

        function handleSort(event) {
            const newSortColumn = event.target.dataset.sort;
            if (!newSortColumn) return;

            if (sortColumn === newSortColumn) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = newSortColumn;
                sortDirection = 'asc';
            }
            renderTable();
        }

        // --- Tab Management ---
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab content
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            
            // Add active class to selected tab button
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            activeBtn.classList.add('active', 'border-blue-500', 'text-blue-600');
            activeBtn.classList.remove('border-transparent', 'text-gray-500');
            
            // Load tab-specific data
            if (tabName === 'grade-requests') {
                loadGradeRequests();
            } else if (tabName === 'verification') {
                loadVerificationData();
            } else if (tabName === 'audit-logs') {
                loadAuditLogs();
            }
        }

        // --- Modal Functions ---
        function openEditModal(studentData) {
            document.getElementById('original-student-id').value = studentData.StudentID;
            document.getElementById('edit-student-id').value = studentData.StudentID || '';
            document.getElementById('edit-first-name').value = studentData.FirstName || '';
            document.getElementById('edit-last-name').value = studentData.LastName || '';
            document.getElementById('edit-major').value = studentData.Major || '';
            document.getElementById('edit-school').value = studentData.School || '';
            document.getElementById('edit-grade').value = studentData.Grade || '';
            document.getElementById('edit-board').value = studentData.Board || '';
            document.getElementById('edit-passing-year').value = studentData.PassingYear || '';
            
            document.getElementById('edit-modal').classList.remove('hidden');
            document.getElementById('edit-modal').classList.add('flex');
        }

        function openGradeRequestModal(studentId) {
            document.getElementById('request-student-id').value = studentId;
            document.getElementById('grade-request-modal').classList.remove('hidden');
            document.getElementById('grade-request-modal').classList.add('flex');
        }

        // --- API Functions for CRUD Operations ---
        async function handleInsert(event) {
            event.preventDefault();
            const student = {
                StudentID: document.getElementById('student-id').value,
                FirstName: document.getElementById('first-name').value,
                LastName: document.getElementById('last-name').value,
                Major: document.getElementById('major').value,
                School: document.getElementById('school').value,
                Grade: document.getElementById('grade').value,
                Board: document.getElementById('board').value,
                PassingYear: document.getElementById('passing-year').value,
            };

            try {
                const response = await apiCall(`${BASE_URL}/api/students`, {
                    method: 'POST',
                    body: JSON.stringify(student),
                });
                const result = await response.json();

                const insertStatus = document.getElementById('insert-status');
                insertStatus.textContent = result.message || result.error;
                insertStatus.className = response.ok ? 'mt-3 text-center font-medium text-green-600' : 'mt-3 text-center font-medium text-red-600';
                
                if (response.ok) {
                    document.getElementById('insert-form').reset();
                    fetchData();
                }
            } catch (error) {
                const insertStatus = document.getElementById('insert-status');
                insertStatus.textContent = 'Error: ' + error.message;
                insertStatus.className = 'mt-3 text-center font-medium text-red-600';
            }
        }

        async function handleUpdate(event) {
            event.preventDefault();
            const originalId = document.getElementById('original-student-id').value;
            const updatedData = {
                StudentID: document.getElementById('edit-student-id').value,
                FirstName: document.getElementById('edit-first-name').value,
                LastName: document.getElementById('edit-last-name').value,
                Major: document.getElementById('edit-major').value,
                School: document.getElementById('edit-school').value,
                Grade: document.getElementById('edit-grade').value,
                Board: document.getElementById('edit-board').value,
                PassingYear: document.getElementById('edit-passing-year').value
            };

            try {
                const response = await apiCall(`${BASE_URL}/api/students/${originalId}`, {
                    method: 'PUT',
                    body: JSON.stringify(updatedData),
                });
                const result = await response.json();
                
                alert(result.message || result.error);
                
                if (response.ok) {
                    document.getElementById('edit-modal').classList.add('hidden');
                    document.getElementById('edit-modal').classList.remove('flex');
                    fetchData();
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function deleteStudent(studentId) {
            try {
                const response = await apiCall(`${BASE_URL}/api/students/${studentId}`, { 
                    method: 'DELETE' 
                });
                const result = await response.json();
                
                alert(result.message || result.error);
                if (response.ok) {
                    fetchData();
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function handleGradeRequest(event) {
            event.preventDefault();
            const requestData = {
                student_id: document.getElementById('request-student-id').value,
                new_grade: document.getElementById('request-new-grade').value,
                change_type: document.getElementById('request-change-type').value,
                reason: document.getElementById('request-reason').value
            };

            try {
                const response = await apiCall(`${BASE_URL}/api/grade-change-requests`, {
                    method: 'POST',
                    body: JSON.stringify(requestData),
                });
                const result = await response.json();
                
                alert(result.message || result.error);
                
                if (response.ok) {
                    document.getElementById('grade-request-modal').classList.add('hidden');
                    document.getElementById('grade-request-modal').classList.remove('flex');
                    document.getElementById('grade-request-form').reset();
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // --- Tab-specific data loading functions ---
        async function loadGradeRequests() {
            try {
                const response = await apiCall(`${BASE_URL}/api/grade-change-requests`);
                const requests = await response.json();
                
                const table = document.getElementById('grade-requests-table');
                if (requests.length === 0) {
                    table.innerHTML = '<p class="text-center text-gray-500">No grade change requests found.</p>';
                } else {
                    table.innerHTML = `
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Request ID</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Student</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Old Grade</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">New Grade</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${requests.map(req => `
                                    <tr>
                                        <td class="px-4 py-4 whitespace-nowrap">${req.RequestID}</td>
                                        <td class="px-4 py-4 whitespace-nowrap">${req.StudentName}</td>
                                        <td class="px-4 py-4 whitespace-nowrap">${req.OldGrade || 'N/A'}</td>
                                        <td class="px-4 py-4 whitespace-nowrap">${req.NewGrade}</td>
                                        <td class="px-4 py-4 whitespace-nowrap">
                                            <span class="px-2 py-1 text-xs rounded-full ${
                                                req.Status === 'approved' ? 'bg-green-100 text-green-800' :
                                                req.Status === 'rejected' ? 'bg-red-100 text-red-800' :
                                                'bg-yellow-100 text-yellow-800'
                                            }">
                                                ${req.Status}
                                            </span>
                                        </td>
                                        <td class="px-4 py-4 whitespace-nowrap">
                                            ${canApproveChanges() && req.Status === 'pending' ? `
                                                <button class="approve-btn text-green-600 hover:text-green-800 font-medium mr-2" data-request-id="${req.RequestID}">Approve</button>
                                                <button class="reject-btn text-red-600 hover:text-red-800 font-medium" data-request-id="${req.RequestID}">Reject</button>
                                            ` : ''}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                document.getElementById('grade-requests-table').innerHTML = 
                    `<p class="text-center text-red-500">Error loading grade requests: ${error.message}</p>`;
            }
        }

        async function loadVerificationData() {
            document.getElementById('verification-content').innerHTML = 
                '<p class="text-center text-gray-500">Verification features coming soon...</p>';
        }

        async function loadAuditLogs() {
            try {
                const response = await apiCall(`${BASE_URL}/api/audit-logs`);
                const logs = await response.json();
                
                const content = document.getElementById('audit-logs-content');
                if (logs.length === 0) {
                    content.innerHTML = '<p class="text-center text-gray-500">No audit logs found.</p>';
                } else {
                    content.innerHTML = `
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Log ID</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Table</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Action</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Changed By</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${logs.map(log => `
                                    <tr>
                                        <td class="px-4 py-4 whitespace-nowrap">${log.LogID}</td>
                                        <td class="px-4 py-4 whitespace-nowrap">${log.TableName}</td>
                                        <td class="px-4 py-4 whitespace-nowrap">${log.Action}</td>
                                        <td class="px-4 py-4 whitespace-nowrap">${log.ChangedByUser || 'System'}</td>
                                        <td class="px-4 py-4 whitespace-nowrap">${new Date(log.ChangedAt).toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                document.getElementById('audit-logs-content').innerHTML = 
                    `<p class="text-center text-red-500">Error loading audit logs: ${error.message}</p>`;
            }
        }

        // --- Event Listeners ---
        loginForm.addEventListener('submit', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);
        document.getElementById('insert-form').addEventListener('submit', handleInsert);
        document.getElementById('edit-form').addEventListener('submit', handleUpdate);
        document.getElementById('grade-request-form').addEventListener('submit', handleGradeRequest);
        document.getElementById('fetch-btn').addEventListener('click', fetchData);
        document.getElementById('search-bar').addEventListener('input', renderTable);
        document.getElementById('data-table-body').addEventListener('click', handleTableClick);
        document.querySelector('thead').addEventListener('click', handleSort);
        document.getElementById('cancel-edit-btn').addEventListener('click', () => {
            document.getElementById('edit-modal').classList.add('hidden');
            document.getElementById('edit-modal').classList.remove('flex');
        });
        document.getElementById('cancel-request-btn').addEventListener('click', () => {
            document.getElementById('grade-request-modal').classList.add('hidden');
            document.getElementById('grade-request-modal').classList.remove('flex');
        });
        document.getElementById('new-request-btn').addEventListener('click', () => {
            document.getElementById('request-student-id').value = '';
            document.getElementById('grade-request-modal').classList.remove('hidden');
            document.getElementById('grade-request-modal').classList.add('flex');
        });

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                switchTab(btn.dataset.tab);
            });
        });

        // Grade request actions
        document.addEventListener('click', (event) => {
            if (event.target.classList.contains('approve-btn')) {
                const requestId = event.target.dataset.requestId;
                approveGradeRequest(requestId);
            } else if (event.target.classList.contains('reject-btn')) {
                const requestId = event.target.dataset.requestId;
                rejectGradeRequest(requestId);
            }
        });

        async function approveGradeRequest(requestId) {
            try {
                const response = await apiCall(`${BASE_URL}/api/grade-change-requests/${requestId}/approve`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                alert(result.message || result.error);
                if (response.ok) {
                    loadGradeRequests();
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function rejectGradeRequest(requestId) {
            const reason = prompt('Enter rejection reason:');
            if (!reason) return;
            
            try {
                const response = await apiCall(`${BASE_URL}/api/grade-change-requests/${requestId}/reject`, {
                    method: 'POST',
                    body: JSON.stringify({ reason })
                });
                const result = await response.json();
                
                alert(result.message || result.error);
                if (response.ok) {
                    loadGradeRequests();
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            showLoginModal();
        });
    </script>
</body>
</html>
